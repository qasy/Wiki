
# Руководство по Qt5
## Здесь содержится информация по сборке и использованию библиотеки Qt-5.12 для Linux Ubuntu 20.04.  
**Примечание: Под использованием в данном руководстве понимается только подключение библиотеки к своему проекту, здесь нет информации по её синтаксису.**  
1. [Сборка Qt5 из Git для Linux/X11](#linux)  
1.1. [Установка пакетов с их зависимостями](#packages-installing)  
1.2. [Получение исходного кода Qt 5](#get-source-code)  
1.3. [Получение исходного кода подмодулей](#get-submodule-source-code)  
2. [Конфигурирование и сборка](#configuring-and-building)  
2.1. [Очистка древа и получение обновлений](#clean-tree)
3. [Использование Qt5 в проектах на основе CMake](#qt-using)
4. [Приложение А: Опции конфигурации Qt](#qt-configure-options)

На всякий случай здесь представлены все версии:  
**https://download.qt.io/official_releases/qt/**  

Оффициальное руководство по сборке и установке:  
**https://wiki.qt.io/Building_Qt_5_from_Git**  

Но здесь будет также продублировано на основе своего опыта.  

### Требования к системе (All desktop platforms):  
```
Git (>= 1.6.x)  
Perl (>=5.14)  
Python (>=2.6.x)  
A working C++ compiler  
```
---------------------------------------------------------------------------------------------------------------------------------------------------------
<a name="linux"></a>
## 1. Сборка Qt5 из Git для Linux/X11 
<a name="packages-installing"></a>
### 1.1. Установка необходимых (и опциональных) пакетов с их зависимостями:  
**Устанавливаем Build essentials (основы сборки), а также Libxcb, QtJsonDb (зависит от libedit)**  
```
sudo apt-get install build-essential perl python git  
```

**Libxcb**  
Libxcb теперь является серверной частью оконной системы по умолчанию для платформ, основанных на X11/Xorg, поэтому вам следует установить libxcb и сопутствующие пакеты. Qt5 должен собираться с любой версией libxcb, доступной в пакетах вашего дистрибутива (но вы можете по желанию использовать версию 1.8 или выше для поддержки многопоточного рендеринга)
```
sudo apt-get install '^libxcb.*-dev' libx11-xcb-dev libglu1-mesa-dev libxrender-dev libxi-dev libxkbcommon-dev libxkbcommon-x11-dev  
sudo apt-get install libedit-dev  
```

**Qt WebKit** (Если нужен, то перед тем как компилировать webkit, нужно установить следующие зависимые пакеты):  
```
sudo apt-get install flex bison gperf libicu-dev libxslt-dev  
```

**Qt WebEngine** (если нужно)  

```
sudo apt-get install libxcursor-dev libxcomposite-dev libxdamage-dev libxrandr-dev libxtst-dev libxss-dev libdbus-1-dev libevent-dev libfontconfig1-dev libcap-dev libpulse-dev libudev-dev libpci-dev libnss3-dev libasound2-dev libegl1-mesa-dev gperf bison nodejs  
```

**Qt Multimedia**  
```
sudo apt-get install libasound2-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libgstreamer-plugins-good1.0-dev libgstreamer-plugins-bad1.0-dev 
```

**QDoc Documentaion Generator Tool**  
```
sudo apt install libclang-6.0-dev llvm-6.0  
```

<a name="get-source-code"></a>
### 1.2. Получение исходного кода Qt 5 / Getting the source code
Сначала перейдем в какую-нибудь папку, куда скачаем исходними, например в home, для этого в любом открытом терминале написать команду:  
```
cd 
```

Сначала клонируйте верхний уровень git репозитария Qt 5:
```
git clone git://code.qt.io/qt/qt5.git qt5  
```

*или (если вы находитесь за межсетевым экраном можно использовать **https** протокол):*  
```
git clone https://code.qt.io/qt/qt5.git qt5  
```

Затем переходим в созданную папку и меняем ветку репозитария на нужную версию (в нашем случаее 5.12): 
```
cd qt5  
git checkout 5.12  
```
<a name="get-submodule-source-code"></a>
### 1.3. Получение исходного кода подмодулей / Getting the submodule source code  
Инициализируем репозиторий с помощью скрипта **init-repository**, который клонирует различные подмодули Qt 5. 
Можно использовать соответствующие опции при инициализации репозитория с помощью perl:  
 - **--module-subset=default,-qtwebengine** - позволяет не загружать qtwebengine при передаче этой опции. Этот модуль довольно большой, компиляция занимает много времени и часто является источником ошибок. Таким образом, рекомендуется загружать и собирать его, только если намереваетесь использовать. В дальнейшем вы всегда можете повторно выполнить init-repository, чтобы добавить этот подмодуль.  
 - **--http** - передайте эту опцию, если находитесь позади брандмауэра.
 
Соответственно делаем следующее:  
```
perl init-repository --module-subset=default,-qtwebengine
```
---------------------------------------------------------------------------------------------------------------------------------------------------------
<a name="configuring-and-building"></a>
## 2. Конфигурирование и сборка / Configuring and Building     
Система сборки Qt5 должна быть довольно устойчивой к любым «внешним отвлекающим факторам» — не имеет значения, есть ли у вас другие версии Qt в PATH, а QTDIR полностью игнорируется. Однако убедитесь, что у вас не установлены специфичные для qmake переменные окружения, такие как QMAKEPATH или QMAKEFEATURES, а выходные данные qmake -query не относятся ни к каким другим версиям Qt ($HOME/.config/Qt/QMake.conf должен быть пустым).  

Примечание. Для сборки документации qdoc и Qt в будущем вы должны установить переменную среды LLVM_INSTALL_DIR, указывающую на каталог, в котором установлен LLVM (это должен быть каталог верхнего уровня, сценарии конфигурации используют относительную трассировку пути из этого каталога). Например, в Linux с LLVM, установленным в изолированном каталоге (/usr/llvm), в командной строке bash следует набрать:  
```
export LLVM_INSTALL_DIR=/usr/llvm
```

Сценарий сборки с именем configure (или configure.bat для Windows) будет находиться в каталоге, в который вы клонировали исходный код (~/qt5, если вы следовали приведенным выше указаниям). Желательно вызывать этот сценарий из другого каталога параллельного уровня, потому что (если вы не используете среду автотестирования Qt) не хочется собирать Qt в каталоге, содержащем исходный код. Для того, чтобы не засорять исходники файлами сборки, будем использовать «теневую сборку», что означает, что сборка выполняется не в исходном каталоге, а в какой-нибудь другой папке. Например, назовем ее qt5-build.  

>Например:  
>Для Linux/macOS для установки в ~/qt5-build (произвольное имя), при условии, что вы находитесь в ~:  
>>```
>>mkdir qt5-build
>>cd qt5-build
>>../qt5/configure **-developer-build** -opensource -nomake examples -nomake tests
>>```
Опция **-developer-build** заставляет экспортировать больше символов, чтобы позволить тестировать больше классов и функций, чем в обычной сборке Qt. Он также по умолчанию использует сборку «debug» и устанавливает двоичные файлы в текущий каталог, избегая необходимости **make install**. Опция **-opensource** устанавливает лицензию GPL/LGPL. Опции **-nomake examples** и **-nomake tests** гарантируют, что примеры и тесты не компилируются по умолчанию. Вы всегда можете решить скомпилировать их позже вручную. **-confirm-license** позволяет принять лицензию и избавиться от вопроса о ее принятии. 

В данном случае, я хочу установить Qt5 в системные пути, поэтому сконфигурирую сборку, без опции **-developer-build**:  
```
mkdir qt5-build  
cd qt5-build
../configure -opensource -nomake examples -nomake tests  
```   
Напишет, что  
```
Qt is now configured for building. Just run 'make'.  
Once everything is built, you must run 'make install'.  
Qt will be installed into '/usr/local/Qt-5.12.12'.  
```

Запустим сборку из каталога сборки: 
```   
make -j8  
```

Примечание. Установка необходима только в том случае, если вы не использовали параметры конфигурации -developer-build или -prefix "%PWD%/qtbase". В противном случае вы можете просто использовать Qt из каталога сборки. Запустить установку (под установкой в Linux подразумевается копирование файлов из каталога сборки в системные каталоги (или други указанные)) можно следующей командой:
```
sudo make install (*необязательно, если выбрали флаг **-developer-build**)  
```   

У меня установился в **/usr/local/Qt-5.12.12** причем эту папку он создал сам, и по запросу **whereis Qt5-5.12.12** выводит этот путь установки  

<a name="clean-tree"></a>
### 2.1. Очистка древа и получение обновлений
Это можно уточнить в официальном руководстве **https://wiki.qt.io/Building_Qt_5_from_Git** 

<a name="qt-using"></a>
## 3. Использование Qt5 в проектах на основе CMake
Для того, чтобы использовать библиотеку в проектах на основе **CMake**, нужно сообщить CMake информацию о том, где билиотека находится. Так как если CMake ничего не знает о местоположении данной установленной библиотеки, то при попытке использовании команды:  
```
find_package(Qt5 COMPONENTS Widgets REQUIRED)  
```
Вылезет ошибка, что:  
```
CMake Error at CMakeLists.txt:14 (find_package):
  By not providing "FindQt5.cmake" in CMAKE_MODULE_PATH this project has
  asked CMake to find a package configuration file provided by "Qt5", but
  CMake did not find one.

  Could not find a package configuration file provided by "Qt5" with any of
  the following names:

    Qt5Config.cmake
    qt5-config.cmake

  Add the installation prefix of "Qt5" to CMAKE_PREFIX_PATH or set "Qt5_DIR"
  to a directory containing one of the above files.  If "Qt5" provides a
  separate development package or SDK, be sure it has been installed.
```

Эта ошибка дает нам информацию,о том, что нужно для корректной работы. Для этого CMake просит передать ему путь к какому-либо из файлов **Qt5Config.cmake** или **qt5-config.cmake**, в которых он может найти необходимую информацию о собранном Qt5. Один из этих файлов нужно постараться найти где-то в каталогах, куда была установлена библиотека Qt5. Выше, в данном руководстве упоминалось, что путь установки в данном случае **/usr/local/Qt-5.12.12**. Следовательно, искать данные файлы нужно здесь. После успешного поиска файла, необходимо сообщить CMake путь к директории, где данный файл лежит (например, путь к файлу: **"/usr/local/Qt-5.12.12/lib/cmake/Qt5/Qt5Config.cmake"**). Это можно сделать с помощью команды:  
```
set(CMAKE_PREFIX_PATH "/usr/local/Qt-5.12.12/lib/cmake/Qt5")  
```
После этого, команда **find_package(Qt5 COMPONENTS Widgets REQUIRED)** должна успешно найти всю информацию о нашей библиотеке. Останется только прилинковать нужные нам компоненты. Пример простейшего **CMakeLists.txt** для данного случая представлен ниже:  
```
cmake_minimum_required(VERSION 3.10)

project(Project LANGUAGES CXX)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# build App
set(CMAKE_PREFIX_PATH "/usr/local/Qt-5.12.12/lib/cmake/Qt5")
find_package(Qt5 COMPONENTS Widgets Charts REQUIRED)
add_executable(App main.cpp)
target_link_libraries(App Qt5::Widgets Qt5::Charts)
```
Стоит добавить, что заголовочные файлы библиотеки находятся там же **"/usr/local/Qt-5.12.12/include** в подпапке **include**. А библиотеки в подпапке **lib**. Это нужно если для вашей IDE необходимо указать расположение хедеров, для нормальной работы инструментов автодополнения кода, например **IntelliSense**.

---------------------------------------------------------------------------------------------------------------------------------------------------------
<a name="qt-configure-options"></a>
## 4. Приложение А: Опции конфигурации Qt / Qt Configure Options  (**Прочтение опционально**)  
**URL: https://doc.qt.io/qt-5/configure-options.html**  
**configure** — это инструмент командной строки, который определяет, как собрать Qt для конкретной платформы. Configure может исключить какую-то функциональность в Qt, а также определить, как Qt создает и развертывает приложения на хост-платформах. Здесь описываются некоторые параметры конфигурации, но чтобы получить полный список параметров, введите команду configure -h. Configure следует запускать из основного исходного каталога Qt.

**Команды на этой странице предназначены для платформ Linux**  
После запуска **configure** соберите исходники с помощью инструмента **make**, в зависимости от вашей платформы.  

### Исходные, сборочные и установочные каталоги / Source, Build, and Install Directories  
**Исходный каталог** содержит исходный код, полученный из исходного пакета или репозитория git. **Каталог сборки** — это место, где хранятся файлы, связанные со сборкой, такие как файлы Makefile, объектные файлы и другие промежуточные файлы. **Каталог установки** — это место, где установлены двоичные файлы и библиотеки для использования либо системой, либо вашим приложением.

Рекомендуется хранить эти каталоги отдельно с помощью теневого построения и использования параметра -prefix. Это позволяет сохранить исходники Qt чистыми от артефактов сборки и двоичных файлов, которые хранятся в отдельном каталоге. Этот способ очень удобен, если вы хотите иметь несколько сборок из одного исходного дерева, но для разных конфигураций. Для теневой сборки запустите configure из отдельного каталога:  
Например:  
```
mkdir ~/qt-build
cd ~/qt-build
~/qt-source/configure -prefix /opt/Qt5.9
qmake
```

Настройка с параметром -prefix означает, что двоичные файлы и библиотеки Qt устанавливаются в другой каталог, в данном случае /opt/Qt5.9. Запуск qmake создает файлы Makefile в каталоге ~/qt-build, а не в исходном каталоге. После создания файлов Makefile выполните следующие команды, чтобы собрать двоичные файлы и библиотеки Qt и установить их:

```
make
make install
```
### Модули и функции / Modules and Features  
Qt состоит из разных модулей, исходные коды которых можно найти в разных каталогах внутри исходного каталога верхнего уровня. Пользователи могут явно исключить определенные каталоги верхнего уровня, чтобы ограничить время сборки. Кроме того, каждый модуль Qt может иметь функции, которые также могут быть явно включены или отключены.  

**Исключение подмодулей Qt / Excluding Qt Modules**  
Опция Configure -skip позволяет исключить исходные каталоги верхнего уровня из сборки Qt. Обратите внимание, что многие каталоги содержат несколько модулей Qt. Например, чтобы исключить Qt NFC и Qt Bluetooth из сборки Qt, укажите -skip qtconnectivity в качестве аргумента для настройки.  

```
./configure -skip qtconnectivity
```

**Включение или исключение фукнций / Including or Excluding Features**  
Параметры: 
```
-feature-<feature> и -no-feature-<feature>
```
включают и исключают определенные функции соответственно.  
Например, чтобы отключить специальные возможности, укажите -no-feature-accessibility в качестве аргумента:  
```
./configure -no-feature-accessibility
```  
Используйте configure -list-features, чтобы отобразить список всех доступных функций в командной строке. Обратите внимание, что функции могут зависеть от других функций, поэтому отключение функции может иметь побочные эффекты для других функций.  
Инструмент конфигурации Qt **The Qt Configuration Tool**, который является частью Qt для создания устройств, позволяет настраивать функции и зависимости через удобный пользовательский интерфейс.  

**Сторонние библиотеки / Third-Party Libraries**  
Пакеты с исходным кодом Qt включают сторонние библиотеки. Чтобы указать, должен ли Qt использовать системные версии библиотек или использовать связанную версию, передайте либо -system, либо -qt перед именем конфигурируемой библиотеки.  
    
В таблице ниже приведены параметры сторонних производителей:  
  
| Library Name | Bundled in Qt | Installed in System |  
| :---         |    :----:     |        :---:        |
| zlib         | -qt-zlib      | -system-zlib        |
| libjpeg      | -qt-libjpeg   | -system-libjpeg     |
| libpng       | -qt-libpng	   | -system-libpng      |
| freetype     | -qt-freetype  | -system-freetype    |
| PCRE         | -qt-pcre      | -system-pcre        |
| HarfBuzz-NG  | -qt-harfbuzz  | -system-harfbuzz    |  
    
Также можно отключить поддержку этих библиотек, используя -no вместо -qt. Например, чтобы использовать системную библиотеку xcb и отключить поддержку zlib, введите следующее:
    
```
./configure -no-zlib -qt-libjpeg -qt-libpng -system-xcb
```
    
Полный список параметров см. в справке по команде configure -help. 
    
**Опции компилятора / Compiler Options**  
Опция -platform задает хост-платформу и компилятор для сборки исходников Qt. Список поддерживаемых платформ и компиляторов находится на странице поддерживаемых платформ, а полный список доступен в каталоге qtbase/mkspecs.  
Например, в системах Ubuntu Linux Qt может быть скомпилирован несколькими компиляторами, такими как clang или g++:  

```
./configure -platform linux-clang
./configure -platform linux-g++
./configure -platform linux-g++-32
```

После этого сгенерированные файлы Makefile будут использовать соответствующие команды компилятора.  

**Сборка разработчика / Developer Builds**  
Опция **-developer-build** не предназначена для доставки приложений, но может использоваться для разработки Qt. Такая сборка содержит больше экспортируемых символов, чем стандартная сборка, и компилируется с более высоким уровнем предупреждений.  
